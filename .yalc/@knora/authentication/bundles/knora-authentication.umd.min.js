!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("json2typescript"),require("@angular/core"),require("@angular/router"),require("@angular/common/http"),require("@knora/core"),require("moment"),require("rxjs/operators"),require("@angular/forms"),require("rxjs"),require("@angular/common"),require("@angular/material/button"),require("@angular/material/card"),require("@angular/material/dialog"),require("@angular/material/form-field"),require("@angular/material/icon"),require("@angular/material/input"),require("@knora/action")):"function"==typeof define&&define.amd?define("@knora/authentication",["exports","json2typescript","@angular/core","@angular/router","@angular/common/http","@knora/core","moment","rxjs/operators","@angular/forms","rxjs","@angular/common","@angular/material/button","@angular/material/card","@angular/material/dialog","@angular/material/form-field","@angular/material/icon","@angular/material/input","@knora/action"],t):t(((e=e||self).knora=e.knora||{},e.knora.authentication={}),e.json2typescript,e.ng.core,e.ng.router,e.ng.common.http,e["@knora/core"],e.moment,e.rxjs.operators,e.ng.forms,e.rxjs,e.ng.common,e.ng.material.button,e.ng.material.card,e.ng.material.dialog,e.ng.material["form-field"],e.ng.material.icon,e.ng.material.input,e["@knora/action"])}(this,function(e,t,r,n,o,i,s,a,u,l,g,d,c,p,m,f,h,y){"use strict";function v(e,t,r,n){var o,i=arguments.length,s=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(i<3?o(s):i>3?o(t,r,s):o(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s}function b(e,t){return function(r,n){t(r,n,e)}}function I(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}var S=function(){function e(){this.name=undefined,this.jwt=undefined,this.lang=undefined,this.sysAdmin=undefined,this.projectAdmin=undefined}return v([t.JsonProperty("name",String),I("design:type",String)],e.prototype,"name",void 0),v([t.JsonProperty("jwt",String,!0),I("design:type",String)],e.prototype,"jwt",void 0),v([t.JsonProperty("lang",String,!0),I("design:type",String)],e.prototype,"lang",void 0),v([t.JsonProperty("sysAdmin",Boolean),I("design:type",Boolean)],e.prototype,"sysAdmin",void 0),v([t.JsonProperty("projectAdmin",[String],!0),I("design:type",Array)],e.prototype,"projectAdmin",void 0),e=v([t.JsonObject],e)}(),w=s,j=function(){function e(e,t,r){this._http=e,this.config=t,this._users=r,this.MAX_SESSION_TIME=864e5}return e.prototype.setSession=function(e,t){var r=this;this.session={id:this.setTimestamp(),user:{name:t,jwt:e,lang:"en",sysAdmin:!1,projectAdmin:[]}},localStorage.setItem("session",JSON.stringify(this.session)),this._users.getUserByUsername(t).subscribe(function(t){var n,o,s=!1,a=[],u=Object.keys(t.permissions.groupsPerProject);try{for(var l=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}(u),g=l.next();!g.done;g=l.next()){var d=g.value;d===i.KnoraConstants.SystemProjectIRI&&(s=t.permissions.groupsPerProject[d].indexOf(i.KnoraConstants.SystemAdminGroupIRI)>-1),t.permissions.groupsPerProject[d].indexOf(i.KnoraConstants.ProjectAdminGroupIRI)>-1&&a.push(d)}}catch(c){n={error:c}}finally{try{g&&!g.done&&(o=l["return"])&&o.call(l)}finally{if(n)throw n.error}}r.session={id:r.setTimestamp(),user:{name:t.username,jwt:e,lang:t.lang,sysAdmin:s,projectAdmin:a}},localStorage.setItem("session",JSON.stringify(r.session))},function(e){console.error(e)})},e.prototype.setTimestamp=function(){return w().add(0,"second").valueOf()},e.prototype.getSession=function(){},e.prototype.updateSession=function(){},e.prototype.validateSession=function(){this.session=JSON.parse(localStorage.getItem("session"));var e=this.setTimestamp();return!!this.session&&(!(this.session.id+this.MAX_SESSION_TIME<e)||(this.authenticate()?(this.session.id=e,localStorage.setItem("session",JSON.stringify(this.session)),!0):(this.destroySession(),!1)))},e.prototype.authenticate=function(){return this._http.get(this.config.api+"/v2/authentication").pipe(a.map(function(e){return 200===e.status}))},e.prototype.destroySession=function(){localStorage.removeItem("session")},e.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new e(r.ɵɵinject(o.HttpClient),r.ɵɵinject(i.KuiCoreConfigToken),r.ɵɵinject(i.UsersService))},token:e,providedIn:"root"}),e=v([r.Injectable({providedIn:"root"}),b(1,r.Inject(i.KuiCoreConfigToken)),I("design:paramtypes",[o.HttpClient,Object,i.UsersService])],e)}(),x=function(){function e(e,t){this._session=e,this._router=t}return e.prototype.canActivate=function(e,t){return!!this._session.validateSession()||(this._router.navigate(["login"],{queryParams:{returnUrl:t.url}}),!1)},e.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new e(r.ɵɵinject(j),r.ɵɵinject(n.Router))},token:e,providedIn:"root"}),e=v([r.Injectable({providedIn:"root"}),I("design:paramtypes",[j,n.Router])],e)}(),E=function(){function e(e,t,r){this.http=e,this._session=t,this.config=r}return e.prototype.session=function(){return this._session.validateSession()},e.prototype.updateSession=function(e,t){return!(!e||!t)&&(this._session.setSession(e,t),!0)},e.prototype.login=function(e,t){var r=this;return this.http.post(this.config.api+"/v2/authentication",{username:e,password:t},{observe:"response"}).pipe(a.map(function(e){return e}),a.catchError(function(e){return r.handleRequestError(e)}))},e.prototype.logout=function(){localStorage.removeItem("session")},e.prototype.handleRequestError=function(e){var t=new i.ApiServiceError;return t.header={server:e.headers.get("Server")},t.status=e.status,t.statusText=e.statusText,t.errorInfo=e.message,t.url=e.url,l.throwError(t)},e.ngInjectableDef=r.ɵɵdefineInjectable({factory:function(){return new e(r.ɵɵinject(o.HttpClient),r.ɵɵinject(j),r.ɵɵinject(i.KuiCoreConfigToken))},token:e,providedIn:"root"}),e=v([r.Injectable({providedIn:"root"}),b(2,r.Inject(i.KuiCoreConfigToken)),I("design:paramtypes",[o.HttpClient,j,Object])],e)}(),_=function(){function e(e,t,r,n,o){this._auth=e,this._session=t,this._fb=r,this._route=n,this._router=o,this.loading=!1,this.loginErrorUser=!1,this.loginErrorPw=!1,this.loginErrorServer=!1,this.login={title:"Login",name:"Username",pw:"Password",button:"Login",remember:"Remember me",forgot_pw:"Forgot password?",error:{failed:"Password or username is wrong",server:"There's an error with the server connection. Try it again later or inform the Knora Team"}},this.formErrors={username:"",password:""},this.validationMessages={username:{required:"user name is required."},password:{required:"password is required"}}}return e.prototype.ngOnInit=function(){this._session.validateSession()?this.loggedInUser=JSON.parse(localStorage.getItem("session")).user.name:this.buildForm()},e.prototype.buildForm=function(){var e=this;this.frm=this._fb.group({username:["",u.Validators.required],password:["",u.Validators.required]}),this.frm.valueChanges.subscribe(function(t){return e.onValueChanged(t)})},e.prototype.onValueChanged=function(e){var t=this;if(this.frm){var r=this.frm;Object.keys(this.formErrors).map(function(e){t.formErrors[e]="";var n=r.get(e);if(n&&n.dirty&&!n.valid){var o=t.validationMessages[e];Object.keys(n.errors).map(function(r){t.formErrors[e]+=o[r]+" "})}})}},e.prototype.doLogin=function(){var e=this;if(this.errorMessage=undefined,this.loginErrorUser=!1,this.loginErrorPw=!1,this.loginErrorServer=!1,this.frm.invalid)return this.loginErrorPw=!0,void(this.loginErrorUser=!0);this.loading=!0;var t=this.frm.get("username").value,r=this.frm.get("password").value;this._auth.login(t,r).subscribe(function(r){e._session.setSession(r.body.token,t),setTimeout(function(){e.returnUrl=e._route.snapshot.queryParams.returnUrl||"/",e.navigate?e._router.navigate([e.navigate]):e._router.navigate([e.returnUrl]),e.loading=!1},2e3)},function(t){0===t.status&&(e.loginErrorUser=!1,e.loginErrorPw=!1,e.loginErrorServer=!0),401===t.status&&(e.loginErrorUser=!1,e.loginErrorPw=!0,e.loginErrorServer=!1),404===t.status&&(e.loginErrorUser=!0,e.loginErrorPw=!1,e.loginErrorServer=!1),e.errorMessage=t,e.loading=!1})},e.prototype.logout=function(){this._auth.logout(),location.reload(!0)},v([r.Input(),I("design:type",String)],e.prototype,"navigate",void 0),v([r.Input(),I("design:type",String)],e.prototype,"color",void 0),e=v([r.Component({selector:"kui-login-form",template:'<div class="login-form" *ngIf="!loggedInUser">\n    <div class="login-form-header">\n        <h3 mat-subheader>{{login.title}}</h3>\n    </div>\n    <div class="login-form-content">\n        \x3c!-- This is the login form --\x3e\n        <form class="login-form" [formGroup]="frm" (ngSubmit)="doLogin()">\n            \x3c!-- Error message --\x3e\n            <mat-hint *ngIf="errorMessage !== undefined" class="full-width">\n                <span *ngIf="loginErrorUser || loginErrorPw">{{login.error.failed}}</span>\n                <span *ngIf="loginErrorServer">{{login.error.server}}</span>\n            </mat-hint>\n\n            \x3c!-- Username --\x3e\n            <mat-form-field class="full-width login-field">\n                <mat-icon matPrefix>person</mat-icon>\n                <input matInput autofocus [placeholder]="login.name" autocomplete="username" formControlName="username">\n                <mat-hint *ngIf="formErrors.username" class="login-error">{{login.error.failed}}</mat-hint>\n            </mat-form-field>\n\n            \x3c!-- Password --\x3e\n            <mat-form-field class="full-width login-field">\n                <mat-icon matPrefix>lock</mat-icon>\n                <input matInput type="password" [placeholder]="login.pw" autocomplete="current-password" formControlName="password">\n                <mat-hint *ngIf="formErrors.password" class="login-error">{{login.error.failed}}</mat-hint>\n            </mat-form-field>\n\n            \x3c!-- Button: Login --\x3e\n            <div class="button-row full-width">\n                <button mat-raised-button type="submit"\n                        *ngIf="!loading"\n                        [disabled]="!frm.valid"\n                        class="full-width submit-button mat-primary">\n                    {{login.button}}\n                </button>\n                <kui-progress-indicator *ngIf="loading" [color]="color"></kui-progress-indicator>\n            </div>\n        </form>\n    </div>\n</div>\n\n\x3c!-- a user is already logged in; show who it is and a logout button --\x3e\n\n<div class="logout-form" *ngIf="loggedInUser">\n    <p>A user is already logged in:</p>\n    <p>{{loggedInUser}}</p>\n    <br>\n    <p>If it\'s not you, please logout!</p>\n    <div class="button-row full-width">\n        <button mat-raised-button\n                (click)="logout()"\n                *ngIf="!loading"\n                class="full-width mat-warn">\n            LOGOUT\n        </button>\n        <kui-progress-indicator *ngIf="loading"></kui-progress-indicator>\n    </div>\n</div>\n',styles:[".full-width{width:100%}.button-row,.mat-form-field,.mat-hint{margin-top:24px}.mat-hint{background:rgba(239,83,80,.39);display:block;margin-left:-16px;padding:16px;text-align:center;width:280px}.login-form,.logout-form{margin-left:auto;margin-right:auto;position:relative;width:280px}.login-form .login-form-header,.logout-form .login-form-header{margin-bottom:24px}.login-form .login-field .mat-icon,.logout-form .login-field .mat-icon{font-size:20px;margin-right:12px}.login-form .button-row,.logout-form .button-row{margin-top:48px}.sign-up{margin-top:24px}"]}),I("design:paramtypes",[E,j,u.FormBuilder,n.ActivatedRoute,n.Router])],e)}(),P=function(){function e(e){this._session=e}return e.prototype.intercept=function(e,t){if(this._session.validateSession()){var r=JSON.parse(localStorage.getItem("session")).user.jwt;e=e.clone({setHeaders:{Authorization:"Bearer "+r}})}else this._session.destroySession();return t.handle(e)},e=v([r.Injectable(),I("design:paramtypes",[j])],e)}(),C=function(){function e(e){this._session=e}return e.prototype.intercept=function(e,t){return e=e.clone({withCredentials:!0}),t.handle(e)},e=v([r.Injectable(),I("design:paramtypes",[j])],e)}(),k=function(){function e(){}return e=v([r.NgModule({imports:[g.CommonModule,y.KuiActionModule,c.MatCardModule,f.MatIconModule,h.MatInputModule,d.MatButtonModule,p.MatDialogModule,m.MatFormFieldModule,u.ReactiveFormsModule,o.HttpClientModule],declarations:[_],exports:[_],providers:[{provide:o.HTTP_INTERCEPTORS,useClass:P,multi:!0},{provide:o.HTTP_INTERCEPTORS,useClass:C,multi:!0}]})],e)}();e.AuthGuard=x,e.AuthenticationService=E,e.CurrentUser=S,e.KuiAuthenticationModule=k,e.LoginFormComponent=_,e.ɵa=j,e.ɵb=P,e.ɵc=C,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=knora-authentication.umd.min.js.map