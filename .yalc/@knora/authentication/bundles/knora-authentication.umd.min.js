!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("json2typescript"),require("@angular/core"),require("@angular/router"),require("@angular/common/http"),require("@knora/core"),require("moment"),require("rxjs/operators"),require("@angular/forms"),require("rxjs"),require("@angular/common"),require("@angular/material/button"),require("@angular/material/card"),require("@angular/material/dialog"),require("@angular/material/form-field"),require("@angular/material/icon"),require("@angular/material/input"),require("@knora/action")):"function"==typeof define&&define.amd?define("@knora/authentication",["exports","json2typescript","@angular/core","@angular/router","@angular/common/http","@knora/core","moment","rxjs/operators","@angular/forms","rxjs","@angular/common","@angular/material/button","@angular/material/card","@angular/material/dialog","@angular/material/form-field","@angular/material/icon","@angular/material/input","@knora/action"],r):r(((e=e||self).knora=e.knora||{},e.knora.authentication={}),e.json2typescript,e.ng.core,e.ng.router,e.ng.common.http,e["@knora/core"],e.moment,e.rxjs.operators,e.ng.forms,e.rxjs,e.ng.common,e.ng.material.button,e.ng.material.card,e.ng.material.dialog,e.ng.material["form-field"],e.ng.material.icon,e.ng.material.input,e["@knora/action"])}(this,function(e,r,t,n,o,i,s,a,u,l,d,c,g,p,f,m,h,y){"use strict";function v(e,r,t,n){var o,i=arguments.length,s=i<3?r:null===n?n=Object.getOwnPropertyDescriptor(r,t):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,r,t,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(i<3?o(s):i>3?o(r,t,s):o(r,t))||s);return i>3&&s&&Object.defineProperty(r,t,s),s}function b(e,r){return function(t,n){r(t,n,e)}}function I(e,r){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,r)}var S=function(){function e(){this.name=undefined,this.jwt=undefined,this.lang=undefined,this.sysAdmin=undefined,this.projectAdmin=undefined}return v([r.JsonProperty("name",String),I("design:type",String)],e.prototype,"name",void 0),v([r.JsonProperty("jwt",String,!0),I("design:type",String)],e.prototype,"jwt",void 0),v([r.JsonProperty("lang",String,!0),I("design:type",String)],e.prototype,"lang",void 0),v([r.JsonProperty("sysAdmin",Boolean),I("design:type",Boolean)],e.prototype,"sysAdmin",void 0),v([r.JsonProperty("projectAdmin",[String],!0),I("design:type",Array)],e.prototype,"projectAdmin",void 0),e=v([r.JsonObject],e)}(),w=s,j=function(){function e(e,r,t){this._http=e,this.config=r,this._users=t,this.MAX_SESSION_TIME=864e5}return e.prototype.setSession=function(e,r){var t=this,n=r.indexOf("@")>-1?"email":"username";this._users.getUser(r,n).subscribe(function(r){var n,o,s=!1,a=[],u=Object.keys(r.permissions.groupsPerProject);try{for(var l=function(e){var r="function"==typeof Symbol&&e[Symbol.iterator],t=0;return r?r.call(e):{next:function(){return e&&t>=e.length&&(e=void 0),{value:e&&e[t++],done:!e}}}}(u),d=l.next();!d.done;d=l.next()){var c=d.value;c===i.KnoraConstants.SystemProjectIRI&&(s=r.permissions.groupsPerProject[c].indexOf(i.KnoraConstants.SystemAdminGroupIRI)>-1),r.permissions.groupsPerProject[c].indexOf(i.KnoraConstants.ProjectAdminGroupIRI)>-1&&a.push(c)}}catch(g){n={error:g}}finally{try{d&&!d.done&&(o=l["return"])&&o.call(l)}finally{if(n)throw n.error}}t.session={id:t.setTimestamp(),user:{name:r.username,jwt:e,lang:r.lang,sysAdmin:s,projectAdmin:a}},localStorage.setItem("session",JSON.stringify(t.session))},function(e){console.error(e)})},e.prototype.setTimestamp=function(){return w().add(0,"second").valueOf()},e.prototype.getSession=function(){},e.prototype.updateSession=function(){},e.prototype.validateSession=function(){this.session=JSON.parse(localStorage.getItem("session"));var e=this.setTimestamp();return!!this.session&&(!(this.session.id+this.MAX_SESSION_TIME<e)||(this.authenticate()?(this.session.id=e,localStorage.setItem("session",JSON.stringify(this.session)),!0):(this.destroySession(),!1)))},e.prototype.authenticate=function(){return this._http.get(this.config.api+"/v2/authentication").pipe(a.map(function(e){return 200===e.status}))},e.prototype.destroySession=function(){localStorage.removeItem("session")},e.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new e(t.ɵɵinject(o.HttpClient),t.ɵɵinject(i.KuiCoreConfigToken),t.ɵɵinject(i.UsersService))},token:e,providedIn:"root"}),e=v([t.Injectable({providedIn:"root"}),b(1,t.Inject(i.KuiCoreConfigToken)),I("design:paramtypes",[o.HttpClient,Object,i.UsersService])],e)}(),x=function(){function e(e,r){this._session=e,this._router=r}return e.prototype.canActivate=function(e,r){return!!this._session.validateSession()||(this._router.navigate(["login"],{queryParams:{returnUrl:r.url}}),!1)},e.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new e(t.ɵɵinject(j),t.ɵɵinject(n.Router))},token:e,providedIn:"root"}),e=v([t.Injectable({providedIn:"root"}),I("design:paramtypes",[j,n.Router])],e)}(),E=function(){function e(e,r,t){this.http=e,this._session=r,this.config=t}return e.prototype.session=function(){return this._session.validateSession()},e.prototype.updateSession=function(e,r){return!(!e||!r)&&(this._session.setSession(e,r),!0)},e.prototype.login=function(e,r){var t=this,n={username:e,password:r};return e.indexOf("@")>-1&&(n={email:e,password:r}),this.http.post(this.config.api+"/v2/authentication",n,{observe:"response"}).pipe(a.map(function(e){return e}),a.catchError(function(e){return t.handleRequestError(e)}))},e.prototype.logout=function(){var e=this;return this.http["delete"](this.config.api+"/v2/authentication").pipe(a.map(function(r){return e._session.destroySession(),r}),a.catchError(function(r){return e.handleRequestError(r)}))},e.prototype.handleRequestError=function(e){var r=new i.ApiServiceError;return r.header={server:e.headers.get("Server")},r.status=e.status,r.statusText=e.statusText,r.errorInfo=e.message,r.url=e.url,l.throwError(r)},e.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new e(t.ɵɵinject(o.HttpClient),t.ɵɵinject(j),t.ɵɵinject(i.KuiCoreConfigToken))},token:e,providedIn:"root"}),e=v([t.Injectable({providedIn:"root"}),b(2,t.Inject(i.KuiCoreConfigToken)),I("design:paramtypes",[o.HttpClient,j,i.KuiCoreConfig])],e)}(),_=function(){function e(e,r,t,n,o){this._auth=e,this._session=r,this._fb=t,this._route=n,this._router=o,this.loading=!1,this.loginErrorUser=!1,this.loginErrorPw=!1,this.loginErrorServer=!1,this.login={title:"Login",name:"Username",pw:"Password",button:"Login",remember:"Remember me",forgot_pw:"Forgot password?",error:{failed:"Password or username is wrong",server:"There's an error with the server connection. Try it again later or inform the Knora Team"}},this.formErrors={username:"",password:""},this.validationMessages={username:{required:"user name is required."},password:{required:"password is required"}}}return e.prototype.ngOnInit=function(){this._session.validateSession()?this.loggedInUser=JSON.parse(localStorage.getItem("session")).user.name:this.buildForm()},e.prototype.buildForm=function(){var e=this;this.frm=this._fb.group({username:["",u.Validators.required],password:["",u.Validators.required]}),this.frm.valueChanges.subscribe(function(r){return e.onValueChanged(r)})},e.prototype.onValueChanged=function(e){var r=this;if(this.frm){var t=this.frm;Object.keys(this.formErrors).map(function(e){r.formErrors[e]="";var n=t.get(e);if(n&&n.dirty&&!n.valid){var o=r.validationMessages[e];Object.keys(n.errors).map(function(t){r.formErrors[e]+=o[t]+" "})}})}},e.prototype.doLogin=function(){var e=this;if(this.errorMessage=undefined,this.loginErrorUser=!1,this.loginErrorPw=!1,this.loginErrorServer=!1,this.frm.invalid)return this.loginErrorPw=!0,void(this.loginErrorUser=!0);this.loading=!0;var r=this.frm.get("username").value,t=this.frm.get("password").value;this._auth.login(r,t).subscribe(function(t){e._session.setSession(t.body.token,r),setTimeout(function(){e.returnUrl=e._route.snapshot.queryParams.returnUrl||"/",e.navigate?e._router.navigate([e.navigate]):e._router.navigate([e.returnUrl]),e.loading=!1},2e3)},function(r){0===r.status&&(e.loginErrorUser=!1,e.loginErrorPw=!1,e.loginErrorServer=!0),401===r.status&&(e.loginErrorUser=!1,e.loginErrorPw=!0,e.loginErrorServer=!1),404===r.status&&(e.loginErrorUser=!0,e.loginErrorPw=!1,e.loginErrorServer=!1),e.errorMessage=r,e.loading=!1})},e.prototype.logout=function(){this._session.destroySession(),location.reload(!0)},v([t.Input(),I("design:type",String)],e.prototype,"navigate",void 0),v([t.Input(),I("design:type",String)],e.prototype,"color",void 0),e=v([t.Component({selector:"kui-login-form",template:'<div class="login-form" *ngIf="!loggedInUser">\n    <div class="login-form-header">\n        <h3 mat-subheader>{{login.title}}</h3>\n    </div>\n    <div class="login-form-content">\n        \x3c!-- This is the login form --\x3e\n        <form class="login-form" [formGroup]="frm" (ngSubmit)="doLogin()">\n            \x3c!-- Error message --\x3e\n            <mat-hint *ngIf="errorMessage !== undefined" class="full-width">\n                <span *ngIf="loginErrorUser || loginErrorPw">{{login.error.failed}}</span>\n                <span *ngIf="loginErrorServer">{{login.error.server}}</span>\n            </mat-hint>\n\n            \x3c!-- Username --\x3e\n            <mat-form-field class="full-width login-field">\n                <mat-icon matPrefix>person</mat-icon>\n                <input matInput autofocus [placeholder]="login.name" autocomplete="username" formControlName="username"\n                       #username cdkFocusInitial>\n                <mat-hint *ngIf="formErrors.username" class="login-error">{{login.error.failed}}</mat-hint>\n            </mat-form-field>\n\n            \x3c!-- Password --\x3e\n            <mat-form-field class="full-width login-field">\n                <mat-icon matPrefix>lock</mat-icon>\n                <input matInput type="password" [placeholder]="login.pw" autocomplete="current-password"\n                       formControlName="password">\n                <mat-hint *ngIf="formErrors.password" class="login-error">{{login.error.failed}}</mat-hint>\n            </mat-form-field>\n\n            \x3c!-- Button: Login --\x3e\n            <div class="button-row full-width">\n                <button mat-raised-button type="submit" *ngIf="!loading" [disabled]="!frm.valid"\n                        class="full-width submit-button mat-primary">\n                    {{login.button}}\n                </button>\n                <kui-progress-indicator *ngIf="loading" [color]="color"></kui-progress-indicator>\n            </div>\n        </form>\n    </div>\n</div>\n\n\x3c!-- a user is already logged in; show who it is and a logout button --\x3e\n\n<div class="logout-form" *ngIf="loggedInUser">\n    <p>A user is already logged in:</p>\n    <p>{{loggedInUser}}</p>\n    <br>\n    <p>If it\'s not you, please logout!</p>\n    <div class="button-row full-width">\n        <button mat-raised-button (click)="logout()" *ngIf="!loading" class="full-width mat-warn">\n            LOGOUT\n        </button>\n        <kui-progress-indicator *ngIf="loading"></kui-progress-indicator>\n    </div>\n</div>\n',styles:[".full-width{width:100%}.button-row,.mat-form-field,.mat-hint{margin-top:24px}.mat-hint{background:rgba(239,83,80,.39);display:block;margin-left:-16px;padding:16px;text-align:center;width:280px}.login-form,.logout-form{margin-left:auto;margin-right:auto;position:relative;width:280px}.login-form .login-form-header,.logout-form .login-form-header{margin-bottom:24px}.login-form .login-field .mat-icon,.logout-form .login-field .mat-icon{font-size:20px;margin-right:12px}.login-form .button-row,.logout-form .button-row{margin-top:48px}.sign-up{margin-top:24px}"]}),I("design:paramtypes",[E,j,u.FormBuilder,n.ActivatedRoute,n.Router])],e)}(),P=function(){function e(e){this._session=e}return e.prototype.intercept=function(e,r){if(this._session.validateSession()){var t=JSON.parse(localStorage.getItem("session")).user.jwt;e=e.clone({setHeaders:{Authorization:"Bearer "+t}})}else this._session.destroySession();return r.handle(e)},e=v([t.Injectable(),I("design:paramtypes",[j])],e)}(),C=function(){function e(e){this._session=e}return e.prototype.intercept=function(e,r){return e=e.clone({withCredentials:!0}),r.handle(e)},e=v([t.Injectable(),I("design:paramtypes",[j])],e)}(),k=function(){function e(){}return e=v([t.NgModule({imports:[d.CommonModule,y.KuiActionModule,g.MatCardModule,m.MatIconModule,h.MatInputModule,c.MatButtonModule,p.MatDialogModule,f.MatFormFieldModule,u.ReactiveFormsModule,o.HttpClientModule],declarations:[_],exports:[_],providers:[{provide:o.HTTP_INTERCEPTORS,useClass:P,multi:!0},{provide:o.HTTP_INTERCEPTORS,useClass:C,multi:!0}]})],e)}();e.AuthGuard=x,e.AuthenticationService=E,e.CurrentUser=S,e.KuiAuthenticationModule=k,e.LoginFormComponent=_,e.ɵa=j,e.ɵb=P,e.ɵc=C,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=knora-authentication.umd.min.js.map