!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("json2typescript"),require("moment"),require("@angular/router"),require("@knora/core"),require("rxjs"),require("rxjs/operators"),require("@angular/common"),require("@angular/common/http"),require("@angular/forms"),require("@angular/material"),require("@knora/action"),require("@angular/core")):"function"==typeof define&&define.amd?define("@knora/authentication",["exports","json2typescript","moment","@angular/router","@knora/core","rxjs","rxjs/operators","@angular/common","@angular/common/http","@angular/forms","@angular/material","@knora/action","@angular/core"],t):t((e.knora=e.knora||{},e.knora.authentication={}),e.json2typescript,e.moment,e.ng.router,e["@knora/core"],e.rxjs,e.rxjs.operators,e.ng.common,e.ng.common.http,e.ng.forms,e.ng.material,e["@knora/action"],e.ng.core)}(this,function(e,t,r,o,g,n,i,s,a,u,l,c,d){"use strict";function p(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(s=(i<3?n(s):3<i?n(t,r,s):n(t,r))||s);return 3<i&&s&&Object.defineProperty(t,r,s),s}function f(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}var m=function(){function e(){this.name=undefined,this.jwt=undefined,this.lang=undefined,this.sysAdmin=undefined,this.projectAdmin=undefined}return p([t.JsonProperty("name",String),f("design:type",String)],e.prototype,"name",void 0),p([t.JsonProperty("jwt",String,!0),f("design:type",String)],e.prototype,"jwt",void 0),p([t.JsonProperty("lang",String,!0),f("design:type",String)],e.prototype,"lang",void 0),p([t.JsonProperty("sysAdmin",Boolean),f("design:type",Boolean)],e.prototype,"sysAdmin",void 0),p([t.JsonProperty("projectAdmin",[String],!0),f("design:type",Array)],e.prototype,"projectAdmin",void 0),e=p([t.JsonObject],e)}(),h=r,y=function(){function e(e,t,r){this._http=e,this.config=t,this._users=r,this.MAX_SESSION_TIME=864e5}return e.prototype.setSession=function(d,e){var p=this,t=-1<e.indexOf("@")?"email":"username";this._users.getUser(e,t).subscribe(function(e){var t,r,o=!1,n=[],i=Object.keys(e.permissions.groupsPerProject);try{for(var s=function l(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}(i),a=s.next();!a.done;a=s.next()){var u=a.value;u===g.KnoraConstants.SystemProjectIRI&&(o=-1<e.permissions.groupsPerProject[u].indexOf(g.KnoraConstants.SystemAdminGroupIRI)),-1<e.permissions.groupsPerProject[u].indexOf(g.KnoraConstants.ProjectAdminGroupIRI)&&n.push(u)}}catch(c){t={error:c}}finally{try{a&&!a.done&&(r=s["return"])&&r.call(s)}finally{if(t)throw t.error}}p.session={id:p.setTimestamp(),user:{name:e.username,jwt:d,lang:e.lang,sysAdmin:o,projectAdmin:n}},localStorage.setItem("session",JSON.stringify(p.session))},function(e){console.error(e)})},e.prototype.setTimestamp=function(){return h().add(0,"second").valueOf()},e.prototype.getSession=function(){},e.prototype.updateSession=function(){},e.prototype.validateSession=function(){this.session=JSON.parse(localStorage.getItem("session"));var e=this.setTimestamp();return!!this.session&&(!(this.session.id+this.MAX_SESSION_TIME<e)||(this.authenticate()?(this.session.id=e,localStorage.setItem("session",JSON.stringify(this.session)),!0):(this.destroySession(),!1)))},e.prototype.authenticate=function(){return this._http.get(this.config.api+"/v2/authentication").pipe(i.map(function(e){return 200===e.status}))},e.prototype.destroySession=function(){localStorage.removeItem("session")},e.decorators=[{type:d.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:a.HttpClient},{type:undefined,decorators:[{type:d.Inject,args:[g.KuiCoreConfigToken]}]},{type:g.UsersService}]},e.ngInjectableDef=d.defineInjectable({factory:function(){return new e(d.inject(a.HttpClient),d.inject(g.KuiCoreConfigToken),d.inject(g.UsersService))},token:e,providedIn:"root"}),e}(),v=function(){function e(e,t){this._session=e,this._router=t}return e.prototype.canActivate=function(e,t){return!!this._session.validateSession()||(this._router.navigate(["login"],{queryParams:{returnUrl:t.url}}),!1)},e.decorators=[{type:d.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:y},{type:o.Router}]},e.ngInjectableDef=d.defineInjectable({factory:function(){return new e(d.inject(y),d.inject(o.Router))},token:e,providedIn:"root"}),e}(),b=function(){function e(e,t,r){this.http=e,this._session=t,this.config=r}return e.prototype.session=function(){return this._session.validateSession()},e.prototype.updateSession=function(e,t){return!(!e||!t)&&(this._session.setSession(e,t),!0)},e.prototype.login=function(e,t){var r=this,o={username:e,password:t};return-1<e.indexOf("@")&&(o={email:e,password:t}),this.http.post(this.config.api+"/v2/authentication",o,{observe:"response"}).pipe(i.map(function(e){return e}),i.catchError(function(e){return r.handleRequestError(e)}))},e.prototype.logout=function(){localStorage.removeItem("session")},e.prototype.handleRequestError=function(e){var t=new g.ApiServiceError;return t.header={server:e.headers.get("Server")},t.status=e.status,t.statusText=e.statusText,t.errorInfo=e.message,t.url=e.url,n.throwError(t)},e.decorators=[{type:d.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:a.HttpClient},{type:y},{type:undefined,decorators:[{type:d.Inject,args:[g.KuiCoreConfigToken]}]}]},e.ngInjectableDef=d.defineInjectable({factory:function(){return new e(d.inject(a.HttpClient),d.inject(y),d.inject(g.KuiCoreConfigToken))},token:e,providedIn:"root"}),e}(),I=function(){function e(e,t,r,o,n){this._auth=e,this._session=t,this._fb=r,this._route=o,this._router=n,this.loading=!1,this.loginErrorUser=!1,this.loginErrorPw=!1,this.loginErrorServer=!1,this.login={title:"Login",name:"Username",pw:"Password",button:"Login",remember:"Remember me",forgot_pw:"Forgot password?",error:{failed:"Password or username is wrong",server:"There's an error with the server connection. Try it again later or inform the Knora Team"}},this.formErrors={username:"",password:""},this.validationMessages={username:{required:"user name is required."},password:{required:"password is required"}}}return e.prototype.ngOnInit=function(){this._session.validateSession()?this.loggedInUser=JSON.parse(localStorage.getItem("session")).user.name:this.buildForm()},e.prototype.buildForm=function(){var t=this;this.frm=this._fb.group({username:["",u.Validators.required],password:["",u.Validators.required]}),this.frm.valueChanges.subscribe(function(e){return t.onValueChanged(e)})},e.prototype.onValueChanged=function(e){var o=this;if(this.frm){var n=this.frm;Object.keys(this.formErrors).map(function(t){o.formErrors[t]="";var e=n.get(t);if(e&&e.dirty&&!e.valid){var r=o.validationMessages[t];Object.keys(e.errors).map(function(e){o.formErrors[t]+=r[e]+" "})}})}},e.prototype.doLogin=function(){var t=this;if(this.errorMessage=undefined,this.loginErrorUser=!1,this.loginErrorPw=!1,this.loginErrorServer=!1,this.frm.invalid)return this.loginErrorPw=!0,void(this.loginErrorUser=!0);this.loading=!0;var r=this.frm.get("username").value,e=this.frm.get("password").value;this._auth.login(r,e).subscribe(function(e){t._session.setSession(e.body.token,r),setTimeout(function(){t.returnUrl=t._route.snapshot.queryParams.returnUrl||"/",t.navigate?t._router.navigate([t.navigate]):t._router.navigate([t.returnUrl]),t.loading=!1},2e3)},function(e){0===e.status&&(t.loginErrorUser=!1,t.loginErrorPw=!1,t.loginErrorServer=!0),401===e.status&&(t.loginErrorUser=!1,t.loginErrorPw=!0,t.loginErrorServer=!1),404===e.status&&(t.loginErrorUser=!0,t.loginErrorPw=!1,t.loginErrorServer=!1),t.errorMessage=e,t.loading=!1})},e.prototype.logout=function(){this._auth.logout(),location.reload(!0)},e.decorators=[{type:d.Component,args:[{selector:"kui-login-form",template:'<div class="login-form" *ngIf="!loggedInUser">\n    <div class="login-form-header">\n        <h3 mat-subheader>{{login.title}}</h3>\n    </div>\n    <div class="login-form-content">\n        \x3c!-- This is the login form --\x3e\n        <form class="login-form" [formGroup]="frm" (ngSubmit)="doLogin()">\n            \x3c!-- Error message --\x3e\n            <mat-hint *ngIf="errorMessage !== undefined" class="full-width">\n                <span *ngIf="loginErrorUser || loginErrorPw">{{login.error.failed}}</span>\n                <span *ngIf="loginErrorServer">{{login.error.server}}</span>\n            </mat-hint>\n\n            \x3c!-- Username --\x3e\n            <mat-form-field class="full-width login-field">\n                <mat-icon matPrefix>person</mat-icon>\n                <input matInput autofocus [placeholder]="login.name" autocomplete="username" formControlName="username"\n                       #username cdkFocusInitial>\n                <mat-hint *ngIf="formErrors.username" class="login-error">{{login.error.failed}}</mat-hint>\n            </mat-form-field>\n\n            \x3c!-- Password --\x3e\n            <mat-form-field class="full-width login-field">\n                <mat-icon matPrefix>lock</mat-icon>\n                <input matInput type="password" [placeholder]="login.pw" autocomplete="current-password"\n                       formControlName="password">\n                <mat-hint *ngIf="formErrors.password" class="login-error">{{login.error.failed}}</mat-hint>\n            </mat-form-field>\n\n            \x3c!-- Button: Login --\x3e\n            <div class="button-row full-width">\n                <button mat-raised-button type="submit" *ngIf="!loading" [disabled]="!frm.valid"\n                        class="full-width submit-button mat-primary">\n                    {{login.button}}\n                </button>\n                <kui-progress-indicator *ngIf="loading" [color]="color"></kui-progress-indicator>\n            </div>\n        </form>\n    </div>\n</div>\n\n\x3c!-- a user is already logged in; show who it is and a logout button --\x3e\n\n<div class="logout-form" *ngIf="loggedInUser">\n    <p>A user is already logged in:</p>\n    <p>{{loggedInUser}}</p>\n    <br>\n    <p>If it\'s not you, please logout!</p>\n    <div class="button-row full-width">\n        <button mat-raised-button (click)="logout()" *ngIf="!loading" class="full-width mat-warn">\n            LOGOUT\n        </button>\n        <kui-progress-indicator *ngIf="loading"></kui-progress-indicator>\n    </div>\n</div>\n',styles:[".full-width{width:100%}.button-row,.mat-form-field,.mat-hint{margin-top:24px}.mat-hint{background:rgba(239,83,80,.39);display:block;margin-left:-16px;padding:16px;text-align:center;width:280px}.login-form,.logout-form{margin-left:auto;margin-right:auto;position:relative;width:280px}.login-form .login-form-header,.logout-form .login-form-header{margin-bottom:24px}.login-form .login-field .mat-icon,.logout-form .login-field .mat-icon{font-size:20px;margin-right:12px}.login-form .button-row,.logout-form .button-row{margin-top:48px}.sign-up{margin-top:24px}"]}]}],e.ctorParameters=function(){return[{type:b},{type:y},{type:u.FormBuilder},{type:o.ActivatedRoute},{type:o.Router}]},e.propDecorators={navigate:[{type:d.Input}],color:[{type:d.Input}]},e}(),w=function(){function e(e){this._session=e}return e.prototype.intercept=function(e,t){if(this._session.validateSession()){var r=JSON.parse(localStorage.getItem("session")).user.jwt;e=e.clone({setHeaders:{Authorization:"Bearer "+r}})}else this._session.destroySession();return t.handle(e)},e.decorators=[{type:d.Injectable}],e.ctorParameters=function(){return[{type:y}]},e}(),S=function(){function e(e){this._session=e}return e.prototype.intercept=function(e,t){return e=e.clone({withCredentials:!0}),t.handle(e)},e.decorators=[{type:d.Injectable}],e.ctorParameters=function(){return[{type:y}]},e}(),j=function(){function e(){}return e.decorators=[{type:d.NgModule,args:[{imports:[s.CommonModule,c.KuiActionModule,l.MatCardModule,l.MatIconModule,l.MatInputModule,l.MatButtonModule,l.MatDialogModule,l.MatFormFieldModule,u.ReactiveFormsModule,a.HttpClientModule],declarations:[I],exports:[I],providers:[{provide:a.HTTP_INTERCEPTORS,useClass:w,multi:!0},{provide:a.HTTP_INTERCEPTORS,useClass:S,multi:!0}]}]}],e}();e.ɵb=w,e.ɵc=S,e.ɵa=y,e.CurrentUser=m,e.AuthGuard=v,e.LoginFormComponent=I,e.AuthenticationService=b,e.KuiAuthenticationModule=j,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=knora-authentication.umd.min.js.map